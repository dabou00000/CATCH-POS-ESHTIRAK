<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>نظام إدارة اشتراكات الكهرباء</title>
<style>
  :root{
    --primary:#9b1c1c;
    --accent:#d4a017;
    --bg:#fafafa;
    --card:#ffffff;
    --muted:#666;
    --ok:#0a7d34;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111}
  header{position:sticky;top:0;background:var(--primary);color:#fff;padding:12px 16px;z-index:10}
  header h1{margin:0;font-size:18px}
  .tabs{display:flex;gap:8px;overflow:auto;padding:8px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:52px;z-index:9}
  .tab-btn{flex:1;white-space:nowrap;border:1px solid #eee;background:#fff;border-radius:10px;padding:10px 12px;font-weight:600}
  .tab-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  main{padding:12px;max-width:920px;margin-inline:auto}
  .card{background:var(--card);border-radius:14px;padding:14px;margin:10px 0;border:1px solid #eee;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .grid{display:grid;gap:10px}
  @media(min-width:700px){.grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)}}
  label{display:block;font-size:13px;margin-bottom:6px;color:#333}
  input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.ghost{background:#fff;border:1px solid #ddd}
  .btn.ok{background:var(--ok);color:#fff}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;text-align:right;padding:8px}
  th{background:#faf7f0}
  .total{font-weight:800}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f3f3;font-size:12px}
  .section-title{margin:6px 0 2px;font-weight:800;color:#333}
  .print-area{background:#fff;color:#000}
  .hide-print{display:block}
  .customer-option:hover{background:#f5f5f5}
        #customer_dropdown{border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}

        /* Receipt visual improvements: clearer, bolder fonts */
        #printArea, #receipt, #receipt * {
            color: #000 !important;
            font-family: Arial, Helvetica, sans-serif !important;
        }

        /* labels above values */
        #receipt .receipt-label { font-size:12px; color:#333; font-weight:700; margin-bottom:4px; }
        #receipt .receipt-value { font-size:14px; font-weight:800; direction:ltr; text-align:left; font-variant-numeric: tabular-nums; font-family: 'Courier New', monospace !important; }
        #receipt .receipt-middle { text-align:center; font-size:13px; font-weight:700; }
        #receipt .receipt-total { text-align:center; font-size:16px; font-weight:900; }

        /* subscription title (main heading) */
        #receipt .receipt-title { font-size:28px; font-weight:900; text-align:center; letter-spacing:0.4px; margin:0 0 6px 0; }
        #receipt .receipt-subtitle { font-size:12px; color:#666; text-align:center; margin-top:2px }
        #receipt .receipt-meta { font-size:10px; color:#888; text-align:center; margin-top:2px }

        /* customer line: show name and phone on a single clearer line */
        #receipt .receipt-customer { font-size:13px; font-weight:800; text-align:right; margin-bottom:6px; }
        #receipt .receipt-customer .sep { display:inline-block; padding:0 8px; color:#444 }

        /* Ensure print uses same bold/clear fonts */
        @media print {
          #printArea, #receipt { font-family: Arial, Helvetica, sans-serif !important; color:#000 !important; }
          #receipt .receipt-value, #receipt .receipt-total { font-family: 'Courier New', monospace !important; }
        }
  @media print {
    @page { 
      size: 80mm auto; 
      margin: 0; 
    }

    /* أظهر تبويب الفاتورة أثناء الطباعة حتى لو كان مخفي */
    #invoice { 
      display: block !important; 
    }

    /* أخفي كل شيء */
    body * { 
      visibility: hidden !important; 
    }

    /* أظهر فقط منطقة الفاتورة السفلي */
    #printArea, #printArea * { 
      visibility: visible !important; 
    }

    /* اخفِ عناصر الفاتورة غير المرغوبة فوق (النموذج/الأزرار/الكاردات) */
    #invoice .grid,
    #invoice .row,
    #invoice .card:not(#printArea),
    header, .tabs, .hide-print, .tab:not(#invoice) {
      display: none !important;
    }

    /* فاصل صفحات لكل فاتورة */
    .invoice-page { 
      page-break-after: always; 
      break-after: page;
    }
    
    /* تجنب قطع الجداول */
    .invoice-page table { 
      page-break-inside: avoid; 
      break-inside: avoid;
    }
    
    /* إجبار فاصل صفحة بعد كل فاتورة */
    .invoice-page:last-child {
      page-break-after: auto;
    }
    
    /* قص تلقائي للطابعات الحرارية */
    .invoice-page[data-auto-cut="true"] {
      position: relative;
    }
    
    .invoice-page[data-auto-cut="true"]::after {
      content: "";
      display: block;
      height: 0;
      margin: 0;
      padding: 0;
      /* إضافة مسافة إضافية للقص */
      margin-bottom: 10mm;
    }
    
    /* تحسين الطباعة للطابعات الحرارية */
    @media print {
      .invoice-page {
        margin: 0;
        padding: 0;
        border: none;
        box-shadow: none;
      }
      
      /* إجبار فاصل صفحة بعد كل فاتورة عدا الأخيرة */
      .invoice-page:not(:last-child) {
        page-break-after: always !important;
        break-after: page !important;
      }
    }

    /* ضبط مساحة الفاتورة للـ POS */
    #printArea {
      position: absolute; 
      left: 0; 
      top: 0;
      width: 72mm;               /* ضمن حواف رول 80mm */
      padding: 6mm 4mm; 
      margin: 0;
      font-size: 12px; 
      line-height: 1.35;
    }

    #printArea table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 8px;
    }
    
    #printArea th, #printArea td { 
      border: none; 
      padding: 3px 4px; 
      text-align: right; 
      font-size: 10px;
    }
    
    #printArea th { 
      background: #f0f0f0 !important;
      font-weight: 600 !important;
    }
    
    #printArea .total { 
      font-weight: 800; 
      font-size: 12px; 
    }
    
    #printArea tr, #printArea td { 
      page-break-inside: avoid; 
    }
    
    
    /* تحسين الأقسام */
    #printArea div[style*="background:#f8f9fa"] {
      background: #f0f0f0 !important;
      padding: 4px !important;
      margin: 4px 0 !important;
    }
    
    #printArea div[style*="border:2px solid #333"] {
      border: 1px solid #333 !important;
      padding: 6px !important;
      margin: 6px 0 !important;
    }
    
    /* تحسين الرسالة السفلية */
    #printArea div[style*="background:#fff3cd"] {
      background: #fffaf0 !important;
      border: 1px solid #e6d8a7 !important;
      padding: 8px 10px !important;
      font-size: 11px !important;
      color: #6b4f00 !important;
      line-height: 1.4 !important;
      border-radius: 6px !important;
      text-align: center !important;
    }
  }
</style>
</head>
<body>
<header>
  <h1 id="appTitle">نظام إدارة اشتراكات الكهرباء</h1>
</header>

<div class="tabs hide-print">
  <button class="tab-btn active" data-tab="customers">الزبائن</button>
  <button class="tab-btn" data-tab="invoice">إصدار إيصال</button>
  <button class="tab-btn" data-tab="history">السجل</button>
  <button class="tab-btn" data-tab="reports">التقارير</button>
  <button class="tab-btn" data-tab="settings">الإعدادات</button>
</div>

<main>
  <!-- Customers -->
  <section id="customers" class="tab card">
    <div class="row" style="justify-content:space-between">
      <h2>إدارة الزبائن</h2>
      <span class="muted">أضف الزبون مع سعر الكيلو الخاص والمقطوعة</span>
    </div>
    <div class="grid cols-2">
      <div>
        <label>اسم الزبون</label>
        <input id="c_name" placeholder="مثلًا: أبو علي">
      </div>
      <div>
        <label>رقم الهاتف</label>
        <input id="c_phone" placeholder="03 000 000">
      </div>
      <div>
        <label>العنوان</label>
        <input id="c_address" placeholder="الحي - الشارع - تفاصيل">
      </div>
      <div>
        <label>المقطوعة الشهرية</label>
        <input id="c_monthly" type="number" min="0" step="0.01" placeholder="0">
      </div>
      <div>
        <label>سعر الكيلو (خـاص)</label>
        <input id="c_price_kwh" type="number" min="0" step="0.001" placeholder="0">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="btnAddCustomer">إضافة زبون</button>
      <input id="c_search" class="hide-print" placeholder="بحث بالاسم أو الهاتف" style="flex:1">
    </div>
    <div class="card">
      <table id="customersTable">
        <thead>
          <tr><th>الاسم</th><th>الهاتف</th><th>العنوان</th><th>المقطوعة</th><th>سعر الكيلو</th><th class="hide-print">تحكم</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  
  <!-- Delete / Import / Export logic -->
  <div id="dataManagementModals" style="display:none"></div>
  <script>document.addEventListener('DOMContentLoaded', function(){
  // Export Data
  qs('#btnExportData').onclick = async ()=>{
    try{
      const customersData = await RTDB.get('customers');
      const invoicesData = await RTDB.get('invoices');
      const expensesData = await RTDB.get('expenses');
      
      const customers = customersData ? Object.keys(customersData).map(id => ({ id, ...customersData[id] })) : [];
      const invoices = invoicesData ? Object.keys(invoicesData).map(id => ({ id, ...invoicesData[id] })) : [];
      const expenses = expensesData ? Object.keys(expensesData).flatMap(month => 
        Object.keys(expensesData[month]).map(id => ({ id, ...expensesData[month][id] }))
      ) : [];
      
      const payload = { customers, invoices, expenses, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      alert('تم إنشاء ملف النسخة الاحتياطية');
    }catch(e){ console.error(e); alert('فشل التصدير: '+e.message); }
  };

  // Import Data
  qs('#btnImportData').onclick = ()=> qs('#importFileInput').click();
  qs('#importFileInput').onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return; 
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      const counts = { customers: (json.customers||[]).length, invoices: (json.invoices||[]).length, expenses: (json.expenses||[]).length };
      if(!confirm(`سيتم استيراد ${counts.customers} زبون، ${counts.invoices} وصل، ${counts.expenses} مصروف. متابعة؟`)) return;
      // import: add with auto ids
      // import customers
      for(const c of (json.customers||[])){
        const customerId = c.id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
        await RTDB.set(`customers/${customerId}`, { ...c, id: customerId });
      }
      for(const inv of (json.invoices||[])){
        const invoiceId = inv.id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
        await RTDB.set(`invoices/${invoiceId}`, { ...inv, id: invoiceId });
      }
      for(const ex of (json.expenses||[])){
        const expenseId = ex.id || Date.now().toString() + Math.random().toString(36).substr(2, 9);
        const period = ex.period || monthKey(new Date());
        await RTDB.set(`expenses/${period}/${expenseId}`, { ...ex, id: expenseId });
      }
      // log
      const log = { action:'import', counts, by: (window.currentUser&&window.currentUser.uid)||null, at: Date.now() };
      const logId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      await RTDB.set(`adminLogs/${logId}`, log);
      
      alert('تم الاستيراد بنجاح');
    }catch(e){ console.error(e); alert('صيغة غير مدعومة أو فشل القراءة'); }
  };

  // Delete Data (safe)
  qs('#btnDeleteData').onclick = async ()=>{
    const pin = prompt('أدخل كلمة السر للحذف');
    if(pin !== '00'){ alert('كلمة السر غير صحيحة'); return; }
    if(!confirm('هل أنت متأكد من حذف كل البيانات؟ لا يمكن التراجع.')) return;
    const btn = qs('#btnDeleteData'); btn.disabled = true; btn.textContent='جارٍ الحذف...';
    try{
      // delete invoices, customers, expenses (caution: not settings)
      await RTDB.remove('invoices');
      await RTDB.remove('customers');
      await RTDB.remove('expenses');
      await RTDB.remove('reports');
      await RTDB.remove('closedMonths');
      
      // log
      const log = { action:'delete_all', by:(window.currentUser&&window.currentUser.uid)||null, at: Date.now() };
      const logId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      await RTDB.set(`adminLogs/${logId}`, log);
      alert('تم حذف البيانات بنجاح');
    }catch(e){ console.error(e); alert('فشل الحذف: '+e.message); }
    finally{ btn.disabled=false; btn.textContent='حذف البيانات'; }
  };
  });</script>


  <!-- Invoice -->
  <section id="invoice" class="tab card" style="display:none">
    <h2>إنشاء إيصال</h2>
    <div class="grid cols-3">
      <div>
        <label>اختر الزبون</label>
        <input id="inv_customer_search" placeholder="ابحث عن الزبون..." autocomplete="off">
        <select id="inv_customer" style="display:none"></select>
        <div id="customer_dropdown" style="display:none;position:absolute;background:#fff;border:1px solid #ddd;max-height:200px;overflow-y:auto;z-index:1000;width:100%"></div>
      </div>
      <div>
        <label>العداد السابق</label>
        <input id="inv_prev" type="number" step="0.001" placeholder="0">
      </div>
      <div>
        <label>العداد الحالي</label>
        <input id="inv_curr" type="number" step="0.001" placeholder="0">
      </div>

      <div>
        <label>الاستهلاك (كيلو واط)</label>
        <input id="inv_usage" type="number" step="0.001" placeholder="0" disabled>
      </div>
      <div>
        <label>سعر الكيلو</label>
        <input id="inv_price_kwh" type="number" step="0.001" placeholder="0">
      </div>
      <div>
        <label>المقطوعة الشهرية</label>
        <input id="inv_monthly" type="number" step="0.01" placeholder="0">
      </div>

      <div>
        <label>دفعات إضافية</label>
        <input id="inv_extra" type="number" step="0.01" placeholder="0">
      </div>
      <div>
        <label>عملة الدفعات</label>
        <select id="inv_extra_currency">
          <option value="USD">دولار</option>
          <option value="LBP">لبناني</option>
        </select>
      </div>
      <div>
        <label>ملاحظة الدفعة <span style="color:red">*</span></label>
        <input id="inv_extra_note" placeholder="مثال: صيانة/قسط سابق" required>
      </div>

      <div>
        <label>خصم</label>
        <input id="inv_discount" type="number" step="0.01" placeholder="0">
      </div>
      <div>
        <label>العملة الأساسية للإيصال</label>
        <select id="inv_base_currency">
          <option value="USD">دولار</option>
          <option value="LBP">لبناني</option>
        </select>
      </div>
      <div>
        <label>تاريخ الإيصال</label>
        <input id="inv_date" type="date">
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div><span class="pill">المجموع (USD):</span> <strong id="sum_usd">0</strong></div>
        <div><span class="pill">المجموع (LBP):</span> <strong id="sum_lbp">0</strong></div>
      </div>
      <div class="muted">يتم التحويل حسب سعر الصرف من الإعدادات</div>
    </div>

    <div class="row">
      <button class="btn ok" id="btnSaveInvoice">حفظ وطباعة</button>
      <button class="btn ghost" id="btnPreview">معاينة طباعة</button>
      <button class="btn ghost" id="btnTestCalc">اختبار الحساب</button>
    </div>

    <div id="printArea" class="card print-area" style="margin-top:12px">
      <div id="receipt">
        <!-- Filled dynamically -->
      </div>
      <div class="hide-print" style="margin-top:6px">
        <button class="btn primary" onclick="printReceipt()">طباعة</button>
      </div>
    </div>
  </section>

  <!-- History -->
  <section id="history" class="tab card" style="display:none">
    <h2>السجل</h2>
    <div class="row">
      <input id="h_search" placeholder="ابحث بالزبون أو رقم الفاتورة" style="flex:1">
      <input id="h_month" type="month">
      <button class="btn primary" id="btnPrintAll">طباعة الكل</button>
    </div>
    <div class="card">
      <table id="historyTable">
        <thead>
          <tr><th>#</th><th>التاريخ</th><th>الزبون</th><th>الاستهلاك</th><th>الإجمالي USD</th><th>الإجمالي LBP</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Reports -->
  <section id="reports" class="tab card" style="display:none">
    <h2>التقارير الشهرية</h2>
      <div class="row">
      <input id="r_month" type="month">
      <button class="btn primary" id="btnRunReport">عرض التقرير</button>
      <button class="btn" id="btnCloseMonth">إقفال الشهر</button>
    </div>
    <div id="reportArea" class="card">
      <div class="grid cols-3">
        <div><div class="section-title">مجموع الكيلو واط</div><div id="rep_kwh">0</div></div>
        <div><div class="section-title">الإجمالي (USD)</div><div id="rep_usd">0</div></div>
        <div><div class="section-title">الإجمالي (LBP)</div><div id="rep_lbp">0</div></div>
      </div>

      <h3 style="margin-top:16px">المصاريف</h3>
      <div class="grid cols-3">
        <input id="exp_amount" type="number" step="0.01" placeholder="قيمة المصروف">
        <select id="exp_currency"><option value="USD">دولار</option><option value="LBP">لبناني</option></select>
        <input id="exp_note" placeholder="ملاحظة">
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn ghost" id="btnAddExpense">إضافة مصروف</button>
        <div class="muted">المصاريف تُسجّل للشهر المحدّد</div>
      </div>
      <div class="card">
        <table id="expensesTable">
          <thead><tr><th>القيمة</th><th>العملة</th><th>ملاحظة</th><th>تحكم</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="grid cols-3">
          <div><div class="section-title">إجمالي المصاريف (USD)</div><div id="rep_exp_usd">0</div></div>
          <div><div class="section-title">إجمالي المصاريف (LBP)</div><div id="rep_exp_lbp">0</div></div>
          <div><div class="section-title">صافي الربح</div><div id="rep_profit">0</div></div>
        </div>
      </div>
    </div>
    <!-- Archived reports list -->
    <div id="archivedReports" class="card" style="margin-top:12px">
      <!-- Filled dynamically: list of archived months with actions -->
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="tab card" style="display:none">
    <h2>الإعدادات</h2>
    <div class="grid cols-2">
      <div>
        <label>اسم الاشتراك الظاهر على الإيصال</label>
        <input id="s_subscription" placeholder="مثال: اشتراك كهرباء الضيعة">
      </div>
      <div>
        <label>سعر صرف الدولار (LBP لكل 1 USD)</label>
        <input id="s_rate" type="number" step="1" min="1" placeholder="90000">
      </div>
      <div>
        <label>سعر الكيلو الافتراضي (USD)</label>
        <input id="s_price_usd" type="number" step="0.001" placeholder="0.25">
      </div>
      <div>
        <label>سعر الكيلو الافتراضي (LBP)</label>
        <input id="s_price_lbp" type="number" step="1" placeholder="22500">
      </div>
      <div>
        <label>رمز مدير (اختياري)</label>
        <input id="s_admin_pin" type="password" placeholder="PIN">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="btnSaveSettings">حفظ الإعدادات</button>
    </div>
    <hr />
    <h3>إدارة البيانات</h3>
    <div class="row" style="gap:8px;align-items:center">
      <button class="btn ghost" id="btnExportData">تصدير البيانات</button>
      <button class="btn ghost" id="btnImportData">استيراد بيانات</button>
      <button class="btn" id="btnDeleteData" style="background:#c62828;color:#fff">حذف البيانات</button>
      <input type="file" id="importFileInput" accept="application/json" style="display:none" />
    </div>
    <div style="margin-top:6px;color:#666;font-size:13px">ننصح بأخذ Export قبل أي عملية حذف.</div>
  </section>
</main>

<!-- Local Storage Database System -->

<script>
// Local Storage Database System
const LocalDB = {
  // Helper to get storage key with prefix
  getKey(path) {
    return 'subscription_system_' + path;
  },

  // Save data to localStorage
  save(path, data) {
    try {
      const key = this.getKey(path);
      localStorage.setItem(key, JSON.stringify(data));
      return true;
    } catch (error) {
      console.error('Error saving to localStorage:', error);
      return false;
    }
  },

  // Load data from localStorage
  load(path, defaultValue = null) {
    try {
      const key = this.getKey(path);
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : defaultValue;
    } catch (error) {
      console.error('Error loading from localStorage:', error);
      return defaultValue;
    }
  },

  // Remove data from localStorage
  remove(path) {
    try {
      const key = this.getKey(path);
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Error removing from localStorage:', error);
      return false;
    }
  }
};

// Database initialization
async function initDatabase() {
  try {
    // Initialize session manager
    SessionManager.init();
    
    console.log('Local Storage Database initialized successfully for session:', SessionManager.sessionId);
    return true;
  } catch (error) {
    console.error('Local storage initialization failed:', error);
    return false;
  }
}

// Session Management - Get session ID from URL parameter 'id'
const SessionManager = {
  sessionId: null,
  
  init() {
    // Get session ID from URL parameter 'id'
    const urlParams = new URLSearchParams(window.location.search);
    this.sessionId = urlParams.get('id');
    
    if (!this.sessionId) {
      // Generate new session ID and add to URL
      this.sessionId = this.generateSessionId();
      const url = new URL(window.location);
      url.searchParams.set('id', this.sessionId);
      window.history.replaceState({}, '', url);
    }
    
    console.log('Session ID:', this.sessionId);
  },
  
  generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  },
  
  getSessionPath(key) {
    return `sessions/${this.sessionId}/${key}`;
  }
};

// Month key utility function (UTC)
function monthKey(tsOrIso) {
  const d = new Date(tsOrIso);
  return d.getUTCFullYear() + "-" + String(d.getUTCMonth() + 1).padStart(2, '0');
}

// Local Storage Database Operations (replacing Firebase RTDB)
const RTDB = {
  subscriptions: new Map(),
  
  // Subscribe to real-time data (simulated with polling)
  subscribe(path, callback) {
    // Load initial data
    const data = this._loadData(path);
    callback(data);
    
    // Set up polling for real-time updates (every 2 seconds)
    const intervalId = setInterval(() => {
      const newData = this._loadData(path);
      callback(newData);
    }, 2000);
    
    const unsubscribe = () => {
      clearInterval(intervalId);
      this.subscriptions.delete(path);
    };
    
    this.subscriptions.set(path, unsubscribe);
    return unsubscribe;
  },
  
  // Helper to load data based on path structure
  _loadData(path) {
    const parts = path.split('/');
    if (parts.length === 1) {
      // Simple path like 'customers', 'invoices', etc.
      return LocalDB.load(parts[0], {});
    } else {
      // Nested path like 'expenses/2024-01' or 'customers/123456'
      const mainKey = parts[0];
      const nestedKey = parts.slice(1).join('/');
      const mainData = LocalDB.load(mainKey, {});
      
      // Handle nested access - if nestedKey is just an ID, return the item
      if (parts.length === 2) {
        return mainData[nestedKey] || null;
      }
      // For deeper nesting, navigate through the object
      let result = mainData;
      for (const key of parts.slice(1)) {
        result = result && result[key];
        if (result === undefined) return null;
      }
      return result || null;
    }
  },
  
  // Helper to save data based on path structure
  _saveData(path, data) {
    console.log('_saveData called with:', { path, data });
    const parts = path.split('/');
    if (parts.length === 1) {
      // Simple path
      LocalDB.save(parts[0], data);
    } else {
      // Nested path
      const mainKey = parts[0];
      const nestedKey = parts.slice(1);
      const mainData = LocalDB.load(mainKey, {});
      
      console.log('Saving nested data:', { mainKey, nestedKey, mainData, data });
      
      // Handle nested saving
      if (nestedKey.length === 1) {
        // Direct nested item like 'customers/123456'
        mainData[nestedKey[0]] = data;
      } else {
        // Deeper nesting like 'expenses/2024-01/item123'
        let target = mainData;
        for (let i = 0; i < nestedKey.length - 1; i++) {
          if (!target[nestedKey[i]]) {
            target[nestedKey[i]] = {};
          }
          target = target[nestedKey[i]];
        }
        target[nestedKey[nestedKey.length - 1]] = data;
      }
      
      console.log('Final mainData before save:', mainData);
      LocalDB.save(mainKey, mainData);
    }
  },
  
  // Get data once
  async get(path) {
    return new Promise((resolve) => {
      resolve(this._loadData(path));
    });
  },
  
  // Set data
  async set(path, data) {
    return new Promise((resolve) => {
      this._saveData(path, data);
      resolve();
    });
  },
  
  // Push new data (auto-generates ID)
  async push(path, data) {
    return new Promise((resolve) => {
      const generatedId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      const newData = { ...data, id: generatedId };
      
      // Get existing data
      const existingData = this._loadData(path) || {};
      existingData[generatedId] = newData;
      
      this._saveData(path, existingData);
      resolve(generatedId);
    });
  },
  
  // Update specific fields
  async update(path, updates) {
    return new Promise((resolve) => {
      const existingData = this._loadData(path) || {};
      const updatedData = { ...existingData, ...updates };
      this._saveData(path, updatedData);
      resolve();
    });
  },
  
  // Remove data
  async remove(path) {
    return new Promise((resolve) => {
      const parts = path.split('/');
      if (parts.length === 1) {
        LocalDB.remove(parts[0]);
      } else {
        const mainKey = parts[0];
        const nestedKeys = parts.slice(1);
        const mainData = LocalDB.load(mainKey, {});
        
        if (nestedKeys.length === 1) {
          // Remove direct nested item like 'customers/123456'
          delete mainData[nestedKeys[0]];
        } else {
          // Remove deeply nested item
          let target = mainData;
          for (let i = 0; i < nestedKeys.length - 1; i++) {
            if (!target[nestedKeys[i]]) break;
            target = target[nestedKeys[i]];
          }
          if (target && nestedKeys.length > 0) {
            delete target[nestedKeys[nestedKeys.length - 1]];
          }
        }
        LocalDB.save(mainKey, mainData);
      }
      resolve();
    });
  },
  
  // Cleanup all subscriptions
  cleanup() {
    this.subscriptions.forEach((unsubscribe) => {
      try { unsubscribe(); } catch(e) {}
    });
    this.subscriptions.clear();
  }
};

// Global data storage
let customers = [];
let invoices = [];
let expenses = {};
let closedMonths = {};
let settings = {};

// Real-time data listeners
function setupRealtimeListeners() {
  // Listen to customers
  RTDB.subscribe('customers', (data) => {
    customers = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
    renderCustomers();
  });
  
  // Listen to invoices
  RTDB.subscribe('invoices', (data) => {
    console.log('RTDB.subscribe invoices data:', data);
    if (data) {
      invoices = Object.keys(data).map(id => {
        const invoice = { ...data[id] };
        // Ensure id is always a string
        invoice.id = String(id);
        console.log('Loading invoice:', { id, invoice });
        return invoice;
      });
    } else {
      invoices = [];
    }
    console.log('Final invoices array:', invoices);
    renderHistory();
    updateReports();
  });
  
  // Listen to expenses
  RTDB.subscribe('expenses', (data) => {
    expenses = data || {};
    updateReports();
  });
  
  // Listen to closed months
  RTDB.subscribe('closedMonths', (data) => {
    closedMonths = data || {};
    updateCloseMonthButton();
  });
  
  // Listen to settings
  RTDB.subscribe('settings', (data) => {
    settings = data || { 
      title: 'نظام إدارة اشتراكات الكهرباء', 
      subscriptionName: '', 
      rate: 90000, 
      priceUSD: 0.25, 
      priceLBP: 22500, 
      adminPIN: '' 
    };
    renderSettings();
  });
}

// ------- State -------
let nextInvoiceNumber = 1; // رقم الإيصال التالي
let isInitialized = false;

// ------- Initialize App -------
async function initializeApp() {
  try {
    console.log('Initializing app...');
    
    // Initialize database
    const dbConnected = await initDatabase();
    if (!dbConnected) {
      alert('فشل في تهيئة النظام المحلي.');
      return;
    }
    
    console.log('Database initialized: Local Storage Database');
    
    // Setup real-time listeners
    setupRealtimeListeners();
    
    // Load initial data
    const initialSettings = await RTDB.get('settings');
    if (initialSettings) {
      settings = initialSettings;
    } else {
      // Set default settings
      settings = { 
        title: 'نظام إدارة اشتراكات الكهرباء', 
        subscriptionName: '', 
        rate: 90000, 
        priceUSD: 0.25, 
        priceLBP: 22500, 
        adminPIN: '' 
      };
      await RTDB.set('settings', settings);
    }
    
    // Load next invoice number
    const nextNum = await RTDB.get('nextInvoiceNumber');
    nextInvoiceNumber = nextNum || 1;
    
    // Initialize UI
    renderSettings();
    updateReports();
    initDefaults();
    
    isInitialized = true;
    console.log('App initialized successfully');
    
  } catch (error) {
    console.error('Initialization error:', error);
    alert('خطأ في تهيئة التطبيق: ' + error.message);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeApp);

// ------- UI Helpers -------
function qs(s){return document.querySelector(s)}
function qsa(s){return Array.from(document.querySelectorAll(s))}
// Format numbers for display using English digits only (no change to stored values)
function fmt(n){ return Number(n||0).toLocaleString('en-US', {maximumFractionDigits:3}) }
// Update reports in real-time
function updateReports() {
  const selectedMonth = document.getElementById('r_month')?.value || monthKey(new Date());
  
  // Calculate totals for the selected month
  const monthInvoices = invoices.filter(inv => monthKey(inv.ts || inv.date) === selectedMonth);
  const monthExpenses = expenses[selectedMonth] || [];
  
  let totalKwh = 0;
  let totalUsd = 0;
  let totalLbp = 0;
  let expUsd = 0;
  let expLbp = 0;
  
  // Calculate invoice totals
  monthInvoices.forEach(inv => {
    totalKwh += Number(inv.kwh || 0);
    if (inv.currency === 'USD') {
      totalUsd += Number(inv.total || 0);
    } else if (inv.currency === 'LBP') {
      totalLbp += Number(inv.total || 0);
    }
  });
  
  // Calculate expense totals
  monthExpenses.forEach(exp => {
    if (exp.currency === 'USD') {
      expUsd += Number(exp.amount || 0);
    } else if (exp.currency === 'LBP') {
      expLbp += Number(exp.amount || 0);
    }
  });
  
  // Calculate net profits
  const netUsd = totalUsd - expUsd;
  const netLbp = totalLbp - expLbp;
  
  // Update DOM elements
  const elements = {
    '#totalKwh': totalKwh,
    '#totalUsd': totalUsd,
    '#totalLbp': totalLbp,
    '#expUsd': expUsd,
    '#expLbp': expLbp,
    '#netUsd': netUsd,
    '#netLbp': netLbp
  };
  
  Object.entries(elements).forEach(([selector, value]) => {
    const el = document.querySelector(selector);
    if (el) {
      el.textContent = fmt(value);
    }
  });
}

// Update close month button state
function updateCloseMonthButton() {
  const selectedMonth = document.getElementById('r_month')?.value || monthKey(new Date());
  const closeBtn = document.getElementById('btnCloseMonth');
  
  if (closeBtn) {
    const isClosed = closedMonths[selectedMonth] === true;
    closeBtn.disabled = isClosed;
    closeBtn.textContent = isClosed ? 'الشهر مقفول' : 'إقفال الشهر';
  }
}

// Close month function
async function closeMonth() {
  const selectedMonth = document.getElementById('r_month')?.value || monthKey(new Date());
  
  // Check if month is already closed
  if (closedMonths[selectedMonth] === true) {
    alert('هذا الشهر مقفول بالفعل');
    return;
  }
  
  if (!confirm(`هل أنت متأكد من إقفال شهر ${selectedMonth}؟`)) {
    return;
  }
  
  try {
    // Calculate totals for the month
    const monthInvoices = invoices.filter(inv => monthKey(inv.ts || inv.date) === selectedMonth);
    const monthExpenses = expenses[selectedMonth] || [];
    
    let totalKwh = 0;
    let totalUsd = 0;
    let totalLbp = 0;
    let expUsd = 0;
    let expLbp = 0;
    
    // Calculate invoice totals
    monthInvoices.forEach(inv => {
      totalKwh += Number(inv.kwh || 0);
      if (inv.currency === 'USD') {
        totalUsd += Number(inv.total || 0);
      } else if (inv.currency === 'LBP') {
        totalLbp += Number(inv.total || 0);
      }
    });
    
    // Calculate expense totals
    monthExpenses.forEach(exp => {
      if (exp.currency === 'USD') {
        expUsd += Number(exp.amount || 0);
      } else if (exp.currency === 'LBP') {
        expLbp += Number(exp.amount || 0);
      }
    });
    
    // Calculate net profits
    const netUsd = totalUsd - expUsd;
    const netLbp = totalLbp - expLbp;
    
    // Create report summary
    const summary = {
      totalKwh,
      totalUsd,
      totalLbp,
      expUsd,
      expLbp,
      netUsd,
      netLbp,
      closedAt: Date.now()
    };
    
    // Save report summary
    await RTDB.set(`reports/${selectedMonth}/summary`, summary);
    
    // Mark month as closed
    await RTDB.update('closedMonths', { [selectedMonth]: true });
    
    alert(`تم إقفال شهر ${selectedMonth} بنجاح`);
    
  } catch (error) {
    console.error('Error closing month:', error);
    alert('فشل في إقفال الشهر: ' + error.message);
  }
}

// Check if month is closed before allowing modifications
function isMonthClosed(month) {
  return closedMonths[month] === true;
}


// ------- Tabs -------
qsa('.tab-btn').forEach(b=>b.addEventListener('click',async ()=>{
  qsa('.tab-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  qsa('.tab').forEach(s=>s.style.display='none');
  qs('#'+b.dataset.tab).style.display='block';
  // if switching to History tab, reload invoices from server to avoid stale cache
  try{
    if (b.dataset.tab === 'history') {
      await reloadInvoices();
    }
  }catch(e){ console.error('Error reloading invoices on tab switch', e); }
}));

// reload invoices from RTDB and re-render history
async function reloadInvoices(){
  try{
    console.log('Reloading invoices from RTDB...');
    const invoicesData = await RTDB.get('invoices');
    if (invoicesData) {
      invoices = Object.keys(invoicesData).map(id => {
        const invoice = { ...invoicesData[id] };
        // Ensure id is always a string
        invoice.id = String(id);
        return invoice;
      });
    } else {
      invoices = [];
    }
    console.log('Reloaded invoices count=', invoices.length);
    // dedupe by id (keep last occurrence)
    invoices = dedupeInvoices(invoices);
    renderHistory();
  }catch(e){ console.error('reloadInvoices failed', e); }
}

// remove duplicates by invoice id, keep the last (most recent) entry
function dedupeInvoices(list){
  const byId = new Map();
  (list||[]).forEach(item=>{
    if (!item || !item.id) return;
    // overwrite so last occurrence remains
    byId.set(String(item.id), item);
  });
  return Array.from(byId.values());
}

// normalize invoice totals: prefer explicit stored numeric fields, try variants, and ensure types
function normalizeInvoiceTotals(inv){
  // possible fields stored differently in older data
  const usdFields = ['total_usd','totalUsd','totalUSD','totalusd'];
  const lbpFields = ['total_lbp','totalLbp','totalLBP','totallbp'];

  let usd = null;
  let lbp = null;

  usdFields.forEach(f=>{ if(usd==null && inv[f]!=null) usd = Number(inv[f]); });
  lbpFields.forEach(f=>{ if(lbp==null && inv[f]!=null) lbp = Number(inv[f]); });

  // If usd is missing but lbp present and rate is available, derive usd
  if((usd==null || Number.isNaN(usd)) && lbp!=null){
    const rate = Number(inv.exchangeRateUsed || inv.exchangeRate || settings.rate || 90000);
    if (rate) usd = +(lbp / rate).toFixed(2);
  }

  // If lbp is missing but usd present, derive lbp
  if((lbp==null || Number.isNaN(lbp)) && usd!=null){
    const rate = Number(inv.exchangeRateUsed || inv.exchangeRate || settings.rate || 90000);
    if (rate) lbp = Math.round(usd * rate);
  }

  // final fallbacks
  if(usd==null || Number.isNaN(usd)) usd = 0;
  if(lbp==null || Number.isNaN(lbp)) lbp = 0;

  return { usd, lbp };
}

// ------- Settings Init -------
function renderSettings(){
  qs('#appTitle').textContent = settings.title || 'نظام إدارة اشتراكات الكهرباء';
  qs('#s_subscription').value = settings.subscriptionName || '';
  qs('#s_rate').value = settings.rate || 90000;
  qs('#s_price_usd').value = settings.priceUSD || 0;
  qs('#s_price_lbp').value = settings.priceLBP || 0;
  qs('#s_admin_pin').value = settings.adminPIN || '';
}

qs('#btnSaveSettings').onclick = async ()=>{
  try {
    settings.subscriptionName = qs('#s_subscription').value.trim();
    settings.rate = Number(qs('#s_rate').value||90000);
    settings.priceUSD = Number(qs('#s_price_usd').value||0);
    settings.priceLBP = Number(qs('#s_price_lbp').value||0);
    settings.adminPIN = qs('#s_admin_pin').value;
    await RTDB.set('settings', settings);
    alert('تم حفظ الإعدادات');
  } catch (error) {
    console.error('Error saving settings:', error);
    alert('خطأ في حفظ الإعدادات: ' + error.message);
  }
};

// ------- Customers -------
function renderCustomers(){
  const tbody = qs('#customersTable tbody');
  const q = (qs('#c_search').value||'').toLowerCase();
  tbody.innerHTML = '';
  customers
    .filter(c => (c.name+c.phone).toLowerCase().includes(q))
    .forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.name}</td>
        <td>${c.phone||''}</td>
        <td>${c.address||''}</td>
        <td>${fmt(c.monthly||0)}</td>
        <td>${fmt(c.price_kwh||0)}</td>
        <td class="hide-print">
          <button class="btn ghost" data-act="edit" data-i="${i}">تعديل</button>
          <button class="btn ghost" data-act="del" data-i="${i}">حذف</button>
        </td>`;
      tbody.appendChild(tr);
    });
  // dropdown
  const sel = qs('#inv_customer');
  sel.innerHTML = `<option value="">— اختر —</option>` + customers.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');
}

qs('#btnAddCustomer').onclick = async ()=>{
  try {
    const c = {
      name: qs('#c_name').value.trim(),
      phone: qs('#c_phone').value.trim(),
      address: qs('#c_address').value.trim(),
      monthly: Number(qs('#c_monthly').value||0),
      price_kwh: Number(qs('#c_price_kwh').value||0),
    };
    if(!c.name){ alert('أدخل اسم الزبون'); return; }
    
    // Generate auto ID and save to RTDB
    const customerId = await RTDB.push('customers', c);
    
    // Clear form
    qs('#c_name').value = qs('#c_phone').value = qs('#c_address').value = qs('#c_monthly').value = qs('#c_price_kwh').value = '';
    
    alert('تم إضافة الزبون بنجاح');
  } catch (error) {
    console.error('Error adding customer:', error);
    alert('خطأ في إضافة الزبون: ' + error.message);
  }
};

qs('#customersTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const i = Number(btn.dataset.i);
  if(btn.dataset.act==='del'){
    if(confirm('حذف هذا الزبون؟')){
      try {
        const customer = customers[i];
        await RTDB.remove(`customers/${customer.id}`);
        alert('تم حذف الزبون بنجاح');
      } catch (error) {
        console.error('Error deleting customer:', error);
        alert('خطأ في حذف الزبون: ' + error.message);
      }
    }
  }else if(btn.dataset.act==='edit'){
    const c = customers[i];
    qs('#c_name').value=c.name; qs('#c_phone').value=c.phone; qs('#c_address').value=c.address;
    qs('#c_monthly').value=c.monthly; qs('#c_price_kwh').value=c.price_kwh;
    // Update customer in RTDB
    await RTDB.set(`customers/${c.id}`, c);
  }
});

qs('#c_search').oninput = renderCustomers;

// ------- Invoice -------
function latestPrevReading(customerId){
  const invs = invoices.filter(v=>v.customerId===customerId).sort((a,b)=>b.date.localeCompare(a.date));
  return invs[0]?.curr || 0;
}

// البحث في الزبائن
let selectedCustomerIndex = -1;

qs('#inv_customer_search').oninput = (e)=>{
  const query = e.target.value.toLowerCase();
  const dropdown = qs('#customer_dropdown');
  
  if(query.length < 1){
    dropdown.style.display = 'none';
    return;
  }
  
  const filtered = customers.filter((c,i) => 
    c.name.toLowerCase().includes(query) || 
    c.phone?.includes(query)
  );
  
  if(filtered.length === 0){
    dropdown.style.display = 'none';
    return;
  }
  
  dropdown.innerHTML = filtered.map((c,i) => 
    `<div class="customer-option" data-index="${customers.indexOf(c)}" style="padding:8px;cursor:pointer;border-bottom:1px solid #eee">
      <strong>${c.name}</strong><br>
      <small style="color:#666">${c.phone || ''} ${c.address ? '• ' + c.address : ''}</small>
    </div>`
  ).join('');
  
  dropdown.style.display = 'block';
  
  // إضافة مستمعي الأحداث للخيارات
  dropdown.querySelectorAll('.customer-option').forEach(option => {
    option.onclick = () => {
      const idx = Number(option.dataset.index);
      selectCustomer(idx);
      dropdown.style.display = 'none';
    };
  });
};

function selectCustomer(idx){
  const c = customers[idx];
  if(!c) return;
  
  selectedCustomerIndex = idx;
  qs('#inv_customer_search').value = c.name;
  qs('#inv_customer').value = idx;
  qs('#inv_prev').value = latestPrevReading(c.id);
  qs('#inv_price_kwh').value = c.price_kwh || (settings.priceUSD || 0);
  qs('#inv_monthly').value = c.monthly || 0;
  computeInvoiceTotals();
}

// إخفاء القائمة عند النقر خارجها
document.addEventListener('click', (e) => {
  if(!e.target.closest('#inv_customer_search') && !e.target.closest('#customer_dropdown')){
    qs('#customer_dropdown').style.display = 'none';
  }
});


qs('#inv_customer').onchange = (e)=>{
  const idx = Number(e.target.value);
  if(Number.isNaN(idx)) return;
  selectCustomer(idx);
};

['#inv_prev','#inv_curr','#inv_price_kwh','#inv_monthly','#inv_extra','#inv_discount','#inv_extra_currency','#inv_base_currency','#inv_date']
  .forEach(id => qs(id).addEventListener('input', computeInvoiceTotals));

function computeInvoiceTotals(){
  const usage = Math.max(0, Number(qs('#inv_curr').value||0) - Number(qs('#inv_prev').value||0));
  qs('#inv_usage').value = usage;
  const price = Number(qs('#inv_price_kwh').value||0);
  const monthly = Number(qs('#inv_monthly').value||0);
  const extra = Number(qs('#inv_extra').value||0);
  const extraCur = qs('#inv_extra_currency').value;
  const discount = Number(qs('#inv_discount').value||0);
  const rate = Number(settings.rate||90000);

  // الحساب الجديد: (العداد الحالي - العداد السابق) × سعر الكيلو + الاشتراك الشهري + الدفعات الإضافية
  let consumptionValue = price * usage;
  let baseUSD = consumptionValue + monthly;
  let extraUSD = extraCur==='USD' ? extra : (extra / rate);
  let totalUSD = Math.max(0, baseUSD + extraUSD - discount);
  let totalLBP = Math.round(totalUSD * rate);

  // التأكد من أن القيم صحيحة
  console.log('Usage:', usage, 'Price:', price, 'Monthly:', monthly, 'Extra:', extra, 'Total USD:', totalUSD);

  qs('#sum_usd').textContent = fmt(totalUSD);
  qs('#sum_lbp').textContent = fmt(totalLBP);
  renderReceiptPreview();
}

function renderReceiptPreview(){
  const idx = selectedCustomerIndex >= 0 ? selectedCustomerIndex : Number(qs('#inv_customer').value);
  const c = customers[idx];
  const usage = Number(qs('#inv_usage').value||0);
  const price = Number(qs('#inv_price_kwh').value||0);
  const monthly = Number(qs('#inv_monthly').value||0);
  const extra = Number(qs('#inv_extra').value||0);
  const extraCur = qs('#inv_extra_currency').value;
  const note = qs('#inv_extra_note').value||'';
  const discount = Number(qs('#inv_discount').value||0);
  const date = qs('#inv_date').value || new Date().toISOString().slice(0,10);
  const baseCur = qs('#inv_base_currency').value;
  const rate = Number(settings.rate||90000);
  
  // حساب المجموع مباشرة بدلاً من قراءته من الصفحة
  let consumptionValue = price * usage;
  let baseUSD = consumptionValue + monthly;
  let extraUSD = extraCur==='USD' ? extra : (extra / rate);
  let totalUSD = Math.max(0, baseUSD + extraUSD - discount);
  let totalLBP = Math.round(totalUSD * rate);

  const prev = Number(qs('#inv_prev').value||0);
  const curr = Number(qs('#inv_curr').value||0);

  const subscriptionTitle = settings.subscriptionName || 'اشتراك الكهرباء';
  const invoiceNumber = 'R' + nextInvoiceNumber.toString().padStart(6, '0');

  // format values for display according to requirements
  const formattedPrice = Number(price).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
  const formattedMonthly = Number(monthly).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
  const formattedTotalUSD = Number(totalUSD).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
  const formattedTotalLBP = Number(totalLBP).toLocaleString('en-US');

  const html = `
  <!-- Header -->
  <div style="text-align:center;margin-bottom:8px;border-bottom:1px solid #333;padding-bottom:6px">
    <div class="receipt-title">${subscriptionTitle}</div>
    <div class="receipt-subtitle">إيصال سداد</div>
    <div class="receipt-meta">${date} • رقم: ${invoiceNumber}</div>
  </div>

  <!-- Customer Info (compact) -->
  <div style="margin-bottom:6px;padding:2px 0;background:transparent;">
    <div class="receipt-customer">
      <span><strong>الاسم:</strong> ${c?c.name:'—'}</span>
      ${c?.phone?`<span class="sep">|</span><span><strong>الهاتف:</strong> ${c.phone}</span>`:''}
    </div>
  </div>

  <!-- Consumption table (prev first, removed total column) -->
  <div style="margin-bottom:6px">
    <table style="width:100%;border-collapse:collapse;font-size:10px;">
      <thead>
        <tr>
          <th style="padding:3px 6px;border:1px solid #444">العداد السابق</th>
          <th style="padding:3px 6px;border:1px solid #444">العداد الحالي</th>
          <th style="padding:3px 6px;border:1px solid #444">الاستهلاك (ك.و.س)</th>
          <th style="padding:3px 6px;border:1px solid #444">سعر الكيلو</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${Number(prev).toLocaleString('en-US')}</td>
          <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${Number(curr).toLocaleString('en-US')}</td>
          <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${Number(usage).toLocaleString('en-US')}</td>
          <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${formattedPrice} USD</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Fees row: المقطوعة | دفعات إضافية | خصم -->
  <div style="margin-bottom:6px">
    <table style="width:100%;border-collapse:collapse;font-size:10px;">
      <tr>
        <th style="padding:3px 6px;border:1px solid #444">المقطوعة</th>
        <th style="padding:3px 6px;border:1px solid #444">دفعات إضافية</th>
        <th style="padding:3px 6px;border:1px solid #444">خصم</th>
      </tr>
      <tr>
        <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${Number(monthly).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} ${baseCur}</td>
        <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">
          ${Number(extra||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} ${extraCur}
          ${ note ? `<div style="font-size:9px;margin-top:4px;text-align:right;direction:rtl;color:inherit">ملاحظة: ${note}</div>` : '' }
        </td>
        <td style="padding:3px 6px;border:1px solid #444;text-align:right;direction:ltr" lang="en">${Number(discount||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} ${baseCur}</td>
      </tr>
    </table>
  </div>

  <!-- Total -->
  <div style="margin-bottom:6px;padding:6px;border:1px solid #444;border-radius:4px;background:#fff">
    <div style="text-align:right;font-weight:800;font-size:13px;">الإجمالي: <span style="direction:ltr" lang="en">LBP ${formattedTotalLBP}</span>  / <span style="direction:ltr" lang="en">USD ${formattedTotalUSD}</span></div>
  </div>

  <!-- Footer note -->
  <div style="text-align:center;margin-top:6px;padding:10px 12px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:6px;font-size:13px;color:#764c00;font-weight:700;line-height:1.4">
    الرجاء عدم التأخير في تسديد الاشتراك، حرصًا على استمرارية الخدمة وعدم اضطرارنا لقطع الاشتراك.
  </div>
  `;
  qs('#receipt').innerHTML = html;
}

qs('#btnPreview').onclick = ()=>{ renderReceiptPreview(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); };

qs('#btnTestCalc').onclick = ()=>{
  const usage = Math.max(0, Number(qs('#inv_curr').value||0) - Number(qs('#inv_prev').value||0));
  const price = Number(qs('#inv_price_kwh').value||0);
  const monthly = Number(qs('#inv_monthly').value||0);
  const extra = Number(qs('#inv_extra').value||0);
  const discount = Number(qs('#inv_discount').value||0);
  
  const consumptionValue = price * usage;
  const total = consumptionValue + monthly + extra - discount;
  
  alert(`تفاصيل الحساب:
الاستهلاك: ${usage} كيلو واط
سعر الكيلو: ${price}
قيمة الاستهلاك: ${consumptionValue}
المقطوعة: ${monthly}
الدفعات الإضافية: ${extra}
الخصم: ${discount}
المجموع: ${total}`);
};

function printPOS(){
  // إنشاء نافذة طباعة مخصصة لرول POS
  const printWindow = window.open('', '_blank', 'width=300,height=600');
  const receiptContent = document.getElementById('receipt').innerHTML;
  
  printWindow.document.write(`
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8">
      <title>طباعة POS</title>
      <style>
        @page { 
          size: 80mm auto !important; 
          margin: 1mm !important; 
        }
        * { box-sizing: border-box !important; }
        html, body { 
          width: 100% !important; 
          margin: 0 !important; 
          padding: 0 !important; 
          max-width: 80mm !important;
          font-family: Arial, sans-serif !important;
          font-size: 8px !important;
          line-height: 1.0 !important;
        }
        table { 
          width: 100% !important; 
          font-size: 8px !important; 
          border-collapse: collapse !important; 
          max-width: 80mm !important;
        }
        td { 
          padding: 0.5px !important; 
          border-bottom: 1px solid #ccc !important; 
          font-size: 8px !important;
        }
        .total { font-weight: bold !important; }
        div { margin: 0 !important; padding: 0 !important; }
      </style>
    </head>
    <body>
      ${receiptContent}
    </body>
    </html>
  `);
  
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 100);
}

function printPOSDirect(){
  // تأكد إن تبويب الفاتورة مفتوح
  const tabBtn = document.querySelector('.tab-btn[data-tab="invoice"]');
  if (tabBtn && !tabBtn.classList.contains('active')) tabBtn.click();

  // أعِد توليد المعاينة إذا لزم
  if (typeof renderReceiptPreview === 'function') renderReceiptPreview();

  // اطبع
  setTimeout(() => window.print(), 100);
}

function printReceipt(){
  // تأكد إن تبويب الفاتورة مفتوح
  const tabBtn = document.querySelector('.tab-btn[data-tab="invoice"]');
  if (tabBtn && !tabBtn.classList.contains('active')) tabBtn.click();

  // أعِد توليد المعاينة إذا لزم
  if (typeof renderReceiptPreview === 'function') renderReceiptPreview();

  // اطبع
  setTimeout(() => window.print(), 100);
}

function testPrintArea(){
  const printArea = document.getElementById('printArea');
  const receipt = document.getElementById('receipt');
  
  console.log('Print Area:', printArea);
  console.log('Receipt:', receipt);
  console.log('Receipt HTML:', receipt.innerHTML);
  console.log('Receipt Text:', receipt.textContent);
  
  alert(`محتوى منطقة الطباعة:
المنطقة موجودة: ${printArea ? 'نعم' : 'لا'}
المحتوى موجود: ${receipt ? 'نعم' : 'لا'}
طول المحتوى: ${receipt ? receipt.innerHTML.length : 0} حرف
المحتوى: ${receipt ? receipt.textContent.substring(0, 100) + '...' : 'فارغ'}`);
}

qs('#btnSaveInvoice').onclick = async ()=>{
  try {
    const idx = selectedCustomerIndex >= 0 ? selectedCustomerIndex : Number(qs('#inv_customer').value);
    if(Number.isNaN(idx) || !customers[idx]){ alert('اختر الزبون'); return; }
    
    // التحقق من وجود ملاحظة الدفعة الإضافية إذا كانت هناك دفعة إضافية
    const extra = Number(qs('#inv_extra').value||0);
    const extraNote = qs('#inv_extra_note').value.trim();
    if(extra > 0 && !extraNote){
      alert('يجب إدخال ملاحظة للدفعة الإضافية');
      qs('#inv_extra_note').focus();
      return;
    }
    
    const c = customers[idx];
    const date = qs('#inv_date').value || new Date().toISOString().slice(0,10);
    const invoiceNumber = 'R' + nextInvoiceNumber.toString().padStart(6, '0');
    
    // تحديث رقم الإيصال التالي
    nextInvoiceNumber++;
    await RTDB.set('nextInvoiceNumber', nextInvoiceNumber);
    
    // حساب الإجماليات بشكل صحيح من الحقول الحالية (لا نعتمد على نص العرض)
    const rate = Number(settings.rate || 90000);
    const usageCalc = Math.max(0, Number(qs('#inv_curr').value||0) - Number(qs('#inv_prev').value||0));
    const priceCalc = Number(qs('#inv_price_kwh').value||0);
    const monthlyCalc = Number(qs('#inv_monthly').value||0);
    const extraCalc = Number(qs('#inv_extra').value||0);
    const extraCurCalc = qs('#inv_extra_currency').value;
    const discountCalc = Number(qs('#inv_discount').value||0);

    const consumptionValueCalc = priceCalc * usageCalc;
    const baseUSDCalc = consumptionValueCalc + monthlyCalc;
    const extraUSDCalc = extraCurCalc === 'USD' ? extraCalc : (extraCalc / rate);
    const total_usd = Math.max(0, baseUSDCalc + extraUSDCalc - discountCalc);
    const total_lbp = Math.round(total_usd * rate);
    console.log('Computed totals before save:', { usageCalc, priceCalc, monthlyCalc, extraCalc, discountCalc, rate, total_usd, total_lbp });
    
    const usage = Number(qs('#inv_usage').value||0);
    const period = (date || new Date().toISOString().slice(0,10)).slice(0,7);
    const issuedAt = new Date().toISOString();

    const extrasArr = extra > 0 ? [{ label: extraNote || 'دفعة إضافية', value: extra, currency: qs('#inv_extra_currency').value }] : [];

    const data = {
      id: invoiceNumber,
      date,
      period,
      issuedAt,
      customerId: c.id,
      customerName: c.name,
      prev: Number(qs('#inv_prev').value||0),
      curr: Number(qs('#inv_curr').value||0),
      usage: usage,
      consumptionKwh: usage, // alias for compatibility
      price_kwh: Number(qs('#inv_price_kwh').value||0),
      monthly: Number(qs('#inv_monthly').value||0),
      extras: extrasArr,
      extra: extra,
      extra_currency: qs('#inv_extra_currency').value,
      extra_note: extraNote,
      discount: Number(qs('#inv_discount').value||0),
      pricingMode: qs('#inv_base_currency').value,
      exchangeRateUsed: rate,
      total_usd: total_usd,           // ← مهم: رقم فعلي
      total_lbp: total_lbp,           // ← مهم: رقم فعلي
      createdBy: (window.currentUser && window.currentUser.uid) || null,
      invoiceNumber: invoiceNumber
    };
    
    console.log('Saving invoice (payload):', data);
    
    // Check if month is closed
    const invoiceMonth = monthKey(data.date);
    if (isMonthClosed(invoiceMonth)) {
      alert(`لا يمكن إضافة فاتورة لشهر ${invoiceMonth} لأنه مقفول`);
      return;
    }
    
    // Save to RTDB
    await RTDB.set(`invoices/${data.id}`, data);

    // show confirmation before printing
    alert('تم الحفظ! جارٍ فتح معاينة الطباعة...');
    console.log('Post-save invoices (in-memory) count=', invoices.length, invoices.map(x=>x.id));

    // reset current reading only
    qs('#inv_prev').value = data.curr; qs('#inv_curr').value=''; computeInvoiceTotals(); 
    renderHistory();
    runReport(); // تحديث التقارير

    // print the saved invoice (after UI updated)
    setTimeout(()=>{
      try{ printInvoice(invoiceNumber); }catch(e){ console.error('print after save failed', e); }
    }, 300);
  } catch (error) {
    console.error('Error saving invoice:', error);
    alert('خطأ في حفظ الإيصال: ' + error.message);
  }
};


// ------- History -------
function renderHistory(){
  const tbody = qs('#historyTable tbody'); 
  tbody.innerHTML = '';
  let list = invoices.slice().sort((a,b)=> b.date.localeCompare(a.date));

  const q = (qs('#h_search').value||'').toLowerCase();
  const month = qs('#h_month').value || monthKey(new Date());
  
  // Filter by month and search
  list = list.filter(v => {
    const invoiceMonth = monthKey(v.date);
    const matchesMonth = invoiceMonth === month;
    const searchText = (v.customerName || '') + String(v.id || '');
    const matchesSearch = !q || searchText.toLowerCase().includes(q);
    return matchesMonth && matchesSearch;
  });


  list.forEach(v=>{
    const tr = document.createElement('tr');
    console.log('renderHistory row:', v.id, v);
    
    // حساب الإجماليات إذا لم تكن موجودة (للبيانات القديمة)
    // prefer stored totals; if missing, compute from components
    const normalized = normalizeInvoiceTotals(v);
    let totalUSD = normalized.usd;
    let totalLBP = normalized.lbp;

    if ((v.total_usd == null && v.totalUsd == null) && (v.total_lbp == null && v.totalLbp == null)) {
      // حساب من البيانات المتاحة للفواتير القديمة
      const usage = Number(v.usage || 0);
      const price = Number(v.price_kwh || 0);
      const monthly = Number(v.monthly || 0);
      const extra = Number(v.extra || 0);
      const discount = Number(v.discount || 0);
      const rate = Number(settings.rate || 90000);
      
      const consumptionValue = price * usage;
      const extraUSD = v.extra_currency === 'USD' ? extra : (extra / rate);
      totalUSD = Math.max(0, consumptionValue + monthly + extraUSD - discount);
      totalLBP = Math.round(totalUSD * rate);
    }
    
    // Ensure we display the correct invoice number/id
    let displayId;
    
    // Handle case where v.id might be an object (fallback from old data)
    const invoiceId = (typeof v.id === 'object' && v.id !== null) ? 
      (v.id.toString && v.id.toString() !== '[object Object]' ? v.id.toString() : 
       v.invoiceNumber || `ID-${Math.random().toString(36).substr(2, 9)}`) :
      v.id;
    
    // Prioritize invoiceNumber field, then clean invoiceId
    if (v.invoiceNumber && String(v.invoiceNumber).trim() !== '') {
      displayId = String(v.invoiceNumber);
    } else if (invoiceId && String(invoiceId).trim() !== '' && String(invoiceId) !== '[object Object]') {
      displayId = String(invoiceId);
    } else {
      displayId = 'غير محدد';
    }
    
    const safeId = String(invoiceId || '').replace(/'/g, "\\'");
    
    // Debug log for troubleshooting
    console.log('Invoice display debug:', {
      originalId: v.id,
      invoiceNumber: v.invoiceNumber,
      processedInvoiceId: invoiceId,
      displayId: displayId,
      safeId: safeId
    });
    
    tr.innerHTML = `
      <td>${displayId}</td>
      <td>${v.date}</td>
      <td>${v.customerName}</td>
      <td style="text-align:left">${Number(v.usage||0).toLocaleString('en-US')}</td>
      <td style="text-align:left">${totalUSD.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})} USD</td>
      <td style="text-align:left">${totalLBP.toLocaleString('en-US')} LBP</td>
      <td class="hide-print"><button class="btn ghost" onclick="printInvoice('${safeId}')">طباعة</button></td>
    `;
    tbody.appendChild(tr);
  });
}
// helper: open standardized print window for receipt HTML
function openPrintWindow(innerHtml){
  const printerWidth = Number(settings.printerWidth || 72);
  const printWindow = window.open('', '_blank', 'width=300,height=600');
  printWindow.document.write(`<!doctype html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=${printerWidth}mm, initial-scale=1">
      <title>طباعة إيصال</title>
      <style>
        @page { size: ${printerWidth}mm auto; margin: 3mm; }
        html,body{box-sizing:border-box;margin:0;padding:0;background:#fff;color:#000}
        body{display:flex;justify-content:center;align-items:flex-start}
        .print-wrapper{width:${Math.max(48, printerWidth - 8)}mm;padding:3mm;margin:0 auto;font-family:Arial,Helvetica,sans-serif;font-size:10px;line-height:1}
        table{width:100%;border-collapse:collapse;font-size:10px}
        th,td{padding:2px 5px;border:1px solid #444}
        thead th{background:#f5f5f5;font-weight:700}
        .label{color:#333;text-align:right}
        .value{text-align:right}
        .value[lang="en"]{direction:ltr;text-align:left}
        .no-break{page-break-inside:avoid;break-inside:avoid}
        .total-box{border:1px solid #444;padding:6px;border-radius:4px;background:#fff}
        .total-box .amount{font-weight:900;font-size:13px;text-align:right}

        /* Receipt-specific classes kept in print window so History prints match preview */
        .receipt-title { font-size:28px; font-weight:900; text-align:center; letter-spacing:0.4px; margin:0 0 6px 0 }
        .receipt-subtitle { font-size:12px; color:#666; text-align:center; margin-top:2px }
        .receipt-meta { font-size:10px; color:#888; text-align:center; margin-top:2px }
        .receipt-customer { font-size:13px; font-weight:800; text-align:right; margin-bottom:6px }
        .receipt-customer .sep { display:inline-block; padding:0 8px; color:#444 }

        /* Footer note styling (targets inline background used in template) */
        div[style*="background:#fff3cd"] { background:#fffaf0; border:1px solid #e6d8a7; padding:8px 10px; font-size:11px; color:#6b4f00; line-height:1.4; border-radius:6px; text-align:center }
      </style>
    </head>
    <body>
      <div class="print-wrapper">${innerHtml}</div>
    </body>
    </html>`);

  printWindow.document.close();
  try{
    printWindow.addEventListener('load', function(){ try{ printWindow.focus(); printWindow.print(); printWindow.close(); }catch(e){ setTimeout(()=>{ try{ printWindow.print(); printWindow.close(); }catch(_){ } },300); } }, { once:true });
  }catch(e){ setTimeout(()=>{ try{ printWindow.focus(); printWindow.print(); printWindow.close(); }catch(_){ } }, 400); }
}

// print a saved invoice by id using same template and CSS
async function printInvoice(invoiceId){
  try {
    console.log('printInvoice called for', invoiceId);
    const inv = invoices.find(x=>String(x.id)===String(invoiceId));
    console.log('in-memory invoice (from invoices array):', inv);
    if (!inv) {
      console.warn('Invoice not found in DB or memory for id', invoiceId);
    }
    if(!inv){ alert('تعذّر فتح الوصل للطباعة'); return; }

    // Use stored values directly (do not re-run pricing logic)
    const cName = inv.customerName || '';
    const curr = Number(inv.curr||0);
    // determine previous reading: prefer stored field, fallback to curr - usage when available
    const prevRaw = (inv.prev != null) ? inv.prev : (inv.previous != null ? inv.previous : (inv.prevReading != null ? inv.prevReading : null));
    const prev = prevRaw != null ? Number(prevRaw) : (inv.curr != null && inv.usage != null ? Number(inv.curr) - Number(inv.usage) : 0);
    const usage = Number(inv.usage || inv.consumptionKwh || 0);
    // price may be stored in different fields; prefer explicit per-currency fields
    const priceUsd = inv.pricePerKwhUsd ?? inv.price_kwh ?? null;
    const priceLbp = inv.pricePerKwhLbp ?? null;
    const monthly = Number((inv.fixedFeeValue != null ? inv.fixedFeeValue : (inv.monthly != null ? inv.monthly : 0)));
    const extrasArr = Array.isArray(inv.extras) ? inv.extras : (inv.extra ? [{ label: inv.extra_note || 'دفعة إضافية', value: inv.extra, currency: inv.extra_currency || 'USD'}] : []);
    const extraTotal = extrasArr.reduce((s,e)=> s + (Number(e.value||0)), 0);
    const discount = Number(inv.discount||0);
    const rate = Number(inv.exchangeRateUsed || inv.exchangeRate || settings.rate || 90000);

    const totalUSD = inv.total_usd != null ? Number(inv.total_usd) : (inv.totalUsd != null ? Number(inv.totalUsd) : null);
    const totalLBP = inv.total_lbp != null ? Number(inv.total_lbp) : (inv.totalLbp != null ? Number(inv.totalLbp) : null);

    // Prepare display values (prefer stored exact values, fallback to formatted numbers)
    const displayPrice = priceUsd != null ? Number(priceUsd) : (priceLbp != null ? Number(priceLbp) : 0);
    const displayPriceLabel = priceUsd != null ? `${Number(displayPrice).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} USD` : `${Number(displayPrice).toLocaleString('en-US')} LBP`;

    const formattedTotalUSD = totalUSD != null ? Number(totalUSD).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : '—';
    const formattedTotalLBP = totalLBP != null ? Number(totalLBP).toLocaleString('en-US') : '—';

    // Instead of building HTML here, reuse the on-screen preview generator
    // so printed output from History matches the preview exactly.
    const consumptionValue = (priceUsd != null ? Number(priceUsd) : 0) * usage;

    // backup form state
    const backup = {};
    const fields = ['#inv_prev','#inv_curr','#inv_price_kwh','#inv_monthly','#inv_extra','#inv_extra_currency','#inv_extra_note','#inv_discount','#inv_base_currency','#inv_date','#inv_customer'];
    fields.forEach(k=>{ const el = qs(k); backup[k]= el ? el.value : null; });
    const backupSelected = (typeof selectedCustomerIndex !== 'undefined') ? selectedCustomerIndex : -1;

    // ensure customer entry exists in customers[] so renderReceiptPreview shows correct name
    let addedTempCustomer = false; let custIndex = customers.findIndex(c=> String(c.id) === String(inv.customerId));
    if(custIndex === -1){ customers.push({ id: inv.customerId || ('_tmp_'+Math.random().toString(36).slice(2)), name: inv.customerName||'', phone: inv.customerPhone||'' }); custIndex = customers.length-1; addedTempCustomer = true; }

    try{
      // populate form with invoice values
      if(qs('#inv_prev')) qs('#inv_prev').value = inv.prev != null ? inv.prev : '';
      if(qs('#inv_curr')) qs('#inv_curr').value = inv.curr != null ? inv.curr : '';
      if(qs('#inv_price_kwh')) qs('#inv_price_kwh').value = priceUsd != null ? priceUsd : (inv.price_kwh != null ? inv.price_kwh : qs('#inv_price_kwh').value);
      if(qs('#inv_monthly')) qs('#inv_monthly').value = monthly || '';
      if(qs('#inv_extra')) qs('#inv_extra').value = extraTotal || 0;
      if(qs('#inv_extra_currency')) qs('#inv_extra_currency').value = extrasArr[0]?.currency || inv.extra_currency || qs('#inv_extra_currency').value;
      if(qs('#inv_extra_note')) qs('#inv_extra_note').value = extrasArr[0]?.label || inv.extra_note || '';
      if(qs('#inv_discount')) qs('#inv_discount').value = inv.discount || 0;
      if(qs('#inv_base_currency')) qs('#inv_base_currency').value = inv.pricingMode || inv.base_currency || qs('#inv_base_currency').value;
      if(qs('#inv_date')) qs('#inv_date').value = inv.date || qs('#inv_date').value;
      if(qs('#inv_customer')) qs('#inv_customer').value = custIndex;
      selectedCustomerIndex = custIndex;

      // regenerate preview and capture its HTML
      if(typeof renderReceiptPreview === 'function') renderReceiptPreview();
      const receiptHtml = qs('#receipt').innerHTML;

      // open print window with the preview HTML
      openPrintWindow(receiptHtml);
    }finally{
      // restore backed-up form state
      fields.forEach(k=>{ const el = qs(k); if(el && backup[k] != null) el.value = backup[k]; });
      selectedCustomerIndex = backupSelected;
      if(addedTempCustomer) customers.splice(custIndex,1);
      // refresh preview to original state
      if(typeof renderReceiptPreview === 'function') renderReceiptPreview();
    }
  } catch (err) {
    console.error('printInvoice error:', err);
    alert('تعذّر فتح الوصل للطباعة: ' + (err.message || err));
  }
}

// Helper function to wait for window load with timeout
function waitForWindowLoad(win, timeout = 5000) {
  return new Promise((resolve, reject) => {
    if (!win || win.closed) {
      reject(new Error('Window is null or closed'));
      return;
    }

    const timeoutId = setTimeout(() => {
      reject(new Error('Window load timeout'));
    }, timeout);

    const checkReady = () => {
      try {
        if (win.document && win.document.readyState === 'complete') {
          clearTimeout(timeoutId);
          resolve();
        } else {
          setTimeout(checkReady, 100);
        }
      } catch (e) {
        clearTimeout(timeoutId);
        reject(new Error('Cannot access window document: ' + e.message));
      }
    };

    try {
      if (win.document && win.document.readyState === 'complete') {
        clearTimeout(timeoutId);
        resolve();
      } else {
        win.addEventListener('load', () => {
          clearTimeout(timeoutId);
          resolve();
        }, { once: true });
        // Fallback check
        setTimeout(checkReady, 100);
      }
    } catch (e) {
      clearTimeout(timeoutId);
      reject(new Error('Cannot access window: ' + e.message));
    }
  });
}

// Helper function to get filtered invoices for current month
function getFilteredInvoicesForMonth() {
  const month = qs('#h_month').value || monthKey(new Date());
  const q = (qs('#h_search').value||'').toLowerCase();
  
  // Use local timezone for proper month filtering
  const selectedMonth = month; // YYYY-MM format
  const startDate = new Date(selectedMonth + '-01T00:00:00');
  const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 1, 0, 0, 0);
  
  console.log('Filtering invoices for month:', selectedMonth);
  console.log('Date range:', startDate.toISOString(), 'to', endDate.toISOString());
  console.log('Total invoices available:', invoices.length);
  
  return invoices
    .slice()
    .sort((a,b)=> {
      // Sort by date first, then by invoice number for consistent ordering
      const dateCompare = a.date.localeCompare(b.date);
      if (dateCompare !== 0) return dateCompare;
      
      // If dates are equal, sort by invoice number
      const aNum = String(a.invoiceNumber || a.id || '').replace(/[^\d]/g, '');
      const bNum = String(b.invoiceNumber || b.id || '').replace(/[^\d]/g, '');
      return Number(aNum) - Number(bNum);
    })
    .filter(v => {
      // Use local timezone for date comparison
      const invoiceDate = new Date(v.date + 'T00:00:00');
      const matchesMonth = invoiceDate >= startDate && invoiceDate < endDate;
      const searchText = (v.customerName || '') + String(v.id || '');
      const matchesSearch = !q || searchText.toLowerCase().includes(q);
      
      console.log('Invoice:', v.id, 'Date:', v.date, 'InvoiceDate:', invoiceDate.toISOString(), 'Matches:', matchesMonth);
      
      return matchesMonth && matchesSearch;
    });
}

// Enhanced print window function with proper error handling
function openPrintWindowSafe(innerHtml) {
  return new Promise((resolve, reject) => {
    const printerWidth = Number(settings.printerWidth || 72);
    const printWindow = window.open('', '_blank', 'width=300,height=600');
    
    if (!printWindow) {
      reject(new Error('تم منع فتح النافذة. يرجى السماح بالنوافذ المنبثقة (Pop-ups) للموقع.'));
      return;
    }

    try {
      printWindow.document.write(`<!doctype html>
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=${printerWidth}mm, initial-scale=1">
          <title>طباعة إيصال</title>
          <style>
            @page { size: ${printerWidth}mm auto; margin: 3mm; }
            html,body{box-sizing:border-box;margin:0;padding:0;background:#fff;color:#000}
            body{display:flex;justify-content:center;align-items:flex-start}
            .print-wrapper{width:${Math.max(48, printerWidth - 8)}mm;padding:3mm;margin:0 auto;font-family:Arial,Helvetica,sans-serif;font-size:10px;line-height:1}
            table{width:100%;border-collapse:collapse;font-size:10px}
            th,td{padding:2px 5px;border:1px solid #444}
            thead th{background:#f5f5f5;font-weight:700}
            .label{color:#333;text-align:right}
            .value{text-align:right}
            .value[lang="en"]{direction:ltr;text-align:left}
            .no-break{page-break-inside:avoid;break-inside:avoid}
            .total-box{border:1px solid #444;padding:6px;border-radius:4px;background:#fff}
            .total-box .amount{font-weight:900;font-size:13px;text-align:right}

            /* Receipt-specific classes kept in print window so History prints match preview */
            .receipt-title { font-size:28px; font-weight:900; text-align:center; letter-spacing:0.4px; margin:0 0 6px 0 }
            .receipt-subtitle { font-size:12px; color:#666; text-align:center; margin-top:2px }
            .receipt-meta { font-size:10px; color:#888; text-align:center; margin-top:2px }
            .receipt-customer { font-size:13px; font-weight:800; text-align:right; margin-bottom:6px }
            .receipt-customer .sep { display:inline-block; padding:0 8px; color:#444 }

            /* Footer note styling (targets inline background used in template) */
            div[style*="background:#fff3cd"] { background:#fffaf0; border:1px solid #e6d8a7; padding:8px 10px; font-size:11px; color:#6b4f00; line-height:1.4; border-radius:6px; text-align:center }
          </style>
        </head>
        <body>
          <div class="print-wrapper">${innerHtml}</div>
        </body>
        </html>`);

      printWindow.document.close();

      waitForWindowLoad(printWindow)
        .then(() => {
          try {
            if (!printWindow || printWindow.closed) {
              reject(new Error('نافذة الطباعة أُغلقت'));
              return;
            }
            
            if (!printWindow.document) {
              reject(new Error('لا يمكن الوصول لمستند النافذة'));
              return;
            }

            printWindow.focus();
            printWindow.print();
            
            // Wait a bit for print dialog and then close
            setTimeout(() => {
              try {
                if (!printWindow.closed) {
                  printWindow.close();
                }
                resolve();
              } catch (e) {
                console.warn('Error closing window:', e);
                resolve(); // Still resolve as printing might have worked
              }
            }, 1500);
          } catch (e) {
            reject(new Error('خطأ في الطباعة: ' + e.message));
          }
        })
        .catch(reject);
    } catch (e) {
      reject(new Error('خطأ في فتح نافذة الطباعة: ' + e.message));
    }
  });
}

// Add auto-cut support for thermal printers
function addAutoCutSupport(html) {
  // Add CSS for auto-cut and print optimization
  const autoCutCSS = `
    <style>
      @media print {
        .invoice-page[data-auto-cut="true"]::after {
          content: "\\f\\f\\f"; /* Form feed for auto-cut */
          display: block;
          height: 0;
          margin: 0;
          padding: 0;
          font-size: 0;
          line-height: 0;
        }
        
        /* تحسين الطباعة للطابعات الحرارية */
        .invoice-page {
          margin: 0 !important;
          padding: 0 !important;
          border: none !important;
          box-shadow: none !important;
          page-break-inside: avoid !important;
        }
        
        /* إجبار فاصل صفحة بعد كل فاتورة عدا الأخيرة */
        .invoice-page:not(:last-child) {
          page-break-after: always !important;
          break-after: page !important;
        }
        
        /* تحسين الخطوط للطباعة */
        body, .invoice-page {
          font-family: 'Courier New', monospace !important;
          font-size: 10px !important;
          line-height: 1.2 !important;
        }
      }
    </style>
  `;
  
  return autoCutCSS + html;
}

// Enhanced print all function - collect all invoices and print once
async function printAllInvoices() {
  const filteredInvoices = getFilteredInvoicesForMonth();
  
  if (filteredInvoices.length === 0) {
    alert('لا توجد وصولات لهذا الشهر');
    return;
  }
  
  // Show confirmation dialog
  const selectedMonth = qs('#h_month').value || monthKey(new Date());
  const monthName = new Date(selectedMonth + '-01').toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', calendar: 'gregory' });
  if (!confirm(`هل تريد طباعة جميع فواتير شهر ${monthName}؟\nعدد الفواتير: ${filteredInvoices.length}`)) {
    return;
  }

  const printAllBtn = qs('#btnPrintAll');
  const originalText = printAllBtn.textContent;
  const totalCount = filteredInvoices.length;
  
  // Disable button and show progress
  printAllBtn.disabled = true;
  printAllBtn.textContent = `جاري تجميع الفواتير... ${totalCount} وصل`;
  
  try {
    // Create a container to collect all invoice HTMLs
    const allInvoicesHtml = [];
    
    // backup form state
    const backup = {};
    const fields = ['#inv_prev','#inv_curr','#inv_price_kwh','#inv_monthly','#inv_extra','#inv_extra_currency','#inv_extra_note','#inv_discount','#inv_base_currency','#inv_date','#inv_customer'];
    fields.forEach(k=>{ const el = qs(k); backup[k]= el ? el.value : null; });
    const backupSelected = (typeof selectedCustomerIndex !== 'undefined') ? selectedCustomerIndex : -1;

    // Process each invoice to generate HTML
    for (let i = 0; i < filteredInvoices.length; i++) {
      const invoice = filteredInvoices[i];
      
      // Update progress every 5 invoices to avoid UI blocking
      if (i % 5 === 0 || i === filteredInvoices.length - 1) {
        printAllBtn.textContent = `جاري تجميع الفواتير... ${i + 1}/${totalCount}`;
        // Allow UI to update
        await new Promise(resolve => setTimeout(resolve, 10));
      }
      
      try {
        const inv = invoice;
        
        // ensure customer entry exists in customers[] so renderReceiptPreview shows correct name
        let addedTempCustomer = false; 
        let custIndex = customers.findIndex(c=> String(c.id) === String(inv.customerId));
        if(custIndex === -1){ 
          customers.push({ id: inv.customerId || ('_tmp_'+Math.random().toString(36).slice(2)), name: inv.customerName||'', phone: inv.customerPhone||'' }); 
          custIndex = customers.length-1; 
          addedTempCustomer = true; 
        }

        // populate form with invoice values for rendering
        if(qs('#inv_prev')) qs('#inv_prev').value = inv.prev != null ? inv.prev : '';
        if(qs('#inv_curr')) qs('#inv_curr').value = inv.curr != null ? inv.curr : '';
        
        const priceUsd = inv.pricePerKwhUsd ?? inv.price_kwh ?? null;
        if(qs('#inv_price_kwh')) qs('#inv_price_kwh').value = priceUsd != null ? priceUsd : (inv.price_kwh != null ? inv.price_kwh : qs('#inv_price_kwh').value);
        
        const monthly = Number((inv.fixedFeeValue != null ? inv.fixedFeeValue : (inv.monthly != null ? inv.monthly : 0)));
        if(qs('#inv_monthly')) qs('#inv_monthly').value = monthly || '';
        
        const extrasArr = Array.isArray(inv.extras) ? inv.extras : (inv.extra ? [{ label: inv.extra_note || 'دفعة إضافية', value: inv.extra, currency: inv.extra_currency || 'USD'}] : []);
        const extraTotal = extrasArr.reduce((s,e)=> s + (Number(e.value||0)), 0);
        
        if(qs('#inv_extra')) qs('#inv_extra').value = extraTotal || 0;
        if(qs('#inv_extra_currency')) qs('#inv_extra_currency').value = extrasArr[0]?.currency || inv.extra_currency || qs('#inv_extra_currency').value;
        if(qs('#inv_extra_note')) qs('#inv_extra_note').value = extrasArr[0]?.label || inv.extra_note || '';
        if(qs('#inv_discount')) qs('#inv_discount').value = inv.discount || 0;
        if(qs('#inv_base_currency')) qs('#inv_base_currency').value = inv.pricingMode || inv.base_currency || qs('#inv_base_currency').value;
        if(qs('#inv_date')) qs('#inv_date').value = inv.date || qs('#inv_date').value;
        if(qs('#inv_customer')) qs('#inv_customer').value = custIndex;
        selectedCustomerIndex = custIndex;

        // regenerate preview and capture its HTML
        if(typeof renderReceiptPreview === 'function') renderReceiptPreview();
        const receiptHtml = qs('#receipt').innerHTML;
        
        // Wrap each invoice in a page container with proper class
        // Add auto-cut marker for thermal printers
        const invoicePageHtml = `<div class="invoice-page" data-auto-cut="true">${receiptHtml}</div>`;
        allInvoicesHtml.push(invoicePageHtml);
        
        // Clean up temporary customer
        if(addedTempCustomer) customers.splice(custIndex,1);
        
      } catch (error) {
        console.error(`Error processing invoice ${invoice.id}:`, error);
        // Continue with next invoice even if one fails
      }
    }
    
    // Restore form state
    fields.forEach(k=>{ const el = qs(k); if(el && backup[k] != null) el.value = backup[k]; });
    selectedCustomerIndex = backupSelected;
    if(typeof renderReceiptPreview === 'function') renderReceiptPreview();
    
    // Update progress
    printAllBtn.textContent = `جاري الطباعة... ${totalCount} وصل`;
    
    // Print all invoices at once
    if (allInvoicesHtml.length > 0) {
      const combinedHtml = allInvoicesHtml.join('');
      
      // Add auto-cut support for thermal printers
      const enhancedHtml = addAutoCutSupport(combinedHtml);
      
      console.log(`Printing ${allInvoicesHtml.length} invoices for month ${selectedMonth}`);
      
      await openPrintWindowSafe(enhancedHtml);
      alert(`تم طباعة ${allInvoicesHtml.length} وصل بنجاح لشهر ${monthName}`);
    } else {
      alert('لم يتم العثور على فواتير صالحة للطباعة');
    }
    
  } catch (error) {
    console.error('Error in printAllInvoices:', error);
    alert('حدث خطأ أثناء الطباعة: ' + error.message);
  } finally {
    // Restore button state
    printAllBtn.disabled = false;
    printAllBtn.textContent = originalText;
  }
}

renderHistory();
qs('#h_search').oninput = renderHistory;
qs('#h_month').oninput = renderHistory;


// ------- Reports & Expenses -------
function renderExpensesTable(key){
  const list = expenses[key] ? Object.keys(expenses[key]).map(id => ({ id, ...expenses[key][id] })) : [];
  const tbody = qs('#expensesTable tbody'); tbody.innerHTML='';
  list.forEach((e,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmt(e.amount)}</td><td>${e.currency}</td><td>${e.note||''}</td>
    <td><button class="btn ghost" data-i="${i}" id="delExp">حذف</button></td>`;
    tbody.appendChild(tr);
  });
  // delete handler
  tbody.querySelectorAll('#delExp').forEach(btn=>btn.onclick = async ()=>{
    const i = Number(btn.dataset.i);
    const expense = list[i];
    if (expense && expense.id) {
      try {
        await RTDB.remove(`expenses/${key}/${expense.id}`);
        alert('تم حذف المصروف بنجاح');
      } catch (error) {
        console.error('Error deleting expense:', error);
        alert('فشل في حذف المصروف: ' + error.message);
      }
    }
  });
}

function runReport(){
  const key = qs('#r_month').value || monthKey(new Date());
  const rate = Number(settings.rate || 90000);

  const invs = invoices.filter(v => v.date && monthKey(v.date) === key);

  const totalKwh = invs.reduce((s,v)=> s + Number(v.usage||0), 0);
  
  // حساب الإجماليات مع التعامل مع البيانات القديمة
  let totalUSD = 0;
  let totalLBP = 0;
  
  invs.forEach(v => {
    let vUSD = Number(v.total_usd || 0);
    let vLBP = Number(v.total_lbp || 0);
    
    if (!v.total_usd && !v.total_lbp) {
      // حساب من البيانات المتاحة للفواتير القديمة
      const usage = Number(v.usage || 0);
      const price = Number(v.price_kwh || 0);
      const monthly = Number(v.monthly || 0);
      const extra = Number(v.extra || 0);
      const discount = Number(v.discount || 0);
      
      const consumptionValue = price * usage;
      const extraUSD = v.extra_currency === 'USD' ? extra : (extra / rate);
      vUSD = Math.max(0, consumptionValue + monthly + extraUSD - discount);
      vLBP = Math.round(vUSD * rate);
    }
    
    totalUSD += vUSD;
    totalLBP += vLBP;
  });

  qs('#rep_kwh').textContent = Number(totalKwh).toLocaleString('en-US');
  qs('#rep_usd').textContent = Number(totalUSD).toLocaleString('en-US');
  qs('#rep_lbp').textContent = Number(totalLBP).toLocaleString('en-US');

  // المصاريف كما هي (تتجمع حسب الشهر)
  const exps = expenses[key] || [];
  const expUSD = exps.reduce((s,e)=> s + (e.currency==='USD' ? Number(e.amount||0) : Number(e.amount||0)/rate), 0);
  const expLBP = Math.round(expUSD * rate);

  qs('#rep_exp_usd').textContent = Number(expUSD).toLocaleString('en-US');
  qs('#rep_exp_lbp').textContent = Number(expLBP).toLocaleString('en-US');
  const profitUSD = totalUSD - expUSD;
  qs('#rep_profit').textContent = `${Number(profitUSD).toLocaleString('en-US')} USD (~ ${Number(Math.round(profitUSD*rate)).toLocaleString('en-US')} LBP)`;

  renderExpensesTable(key);

  // load archived reports list (local or firebase)
  loadArchivedReportsList();
}

// ------------------ Archived reports helpers ------------------
async function createMonthlySnapshot(period){
  // period: YYYY-MM
  const start = period + '-01';
  // compute end of month
  const dt = new Date(period + '-01T00:00:00');
  const endDt = new Date(dt.getFullYear(), dt.getMonth()+1, 0);
  const end = endDt.toISOString().slice(0,10);

  // collect invoices in period (issuedAt may be timestamp or ISO string)
  const invs = invoices.filter(v => v.date && v.date.startsWith(period));

  // compute aggregates (use already-present totals when available)
  const rate = Number(settings.rate||90000);
  let totalKwh = 0, totalUSD = 0, totalLBP = 0, totalExtrasUsd = 0, totalDiscountUsd = 0, totalExpensesUsd = 0;
  const customerMap = new Map();
  const invoiceIds = [];

  invs.forEach(v=>{
    invoiceIds.push(v.id);
    const usage = Number(v.usage||0); totalKwh += usage;
    const normalized = normalizeInvoiceTotals(v);
    totalUSD += normalized.usd; totalLBP += normalized.lbp;
    // extras
    const extrasArr = Array.isArray(v.extras) ? v.extras : (v.extra ? [{ label: v.extra_note || 'دفعة إضافية', value: v.extra, currency: v.extra_currency || 'USD'}] : []);
    extrasArr.forEach(e=>{ totalExtrasUsd += (e.currency==='USD' ? Number(e.value||0) : (Number(e.value||0)/rate)); });
    totalDiscountUsd += Number(v.discount||0);

    // customers summary
    const cid = v.customerId || ('_unknown_');
    const prev = customerMap.get(cid) || { customerId: cid, customerName: v.customerName||'', invoicesCount:0, sumConsumptionKwh:0, sumUsd:0, sumLbp:0 };
    prev.invoicesCount += 1; prev.sumConsumptionKwh += usage; prev.sumUsd += normalized.usd; prev.sumLbp += normalized.lbp;
    customerMap.set(cid, prev);
  });

  // expenses for month
  const exps = expenses[period] || [];
  exps.forEach(e=>{ totalExpensesUsd += (e.currency==='USD' ? Number(e.amount||0) : (Number(e.amount||0)/rate)); });

  const netProfitUsd = totalUSD - totalExpensesUsd;

  // prepare snapshot object
  const snapshot = {
    period,
    createdAt: new Date().toISOString(),
    dateRange: { start, end, timezone: 'Asia/Beirut' },
    exchangeRateUsed: rate,
    pricePerKwhUsd: settings.priceUSD || null,
    pricePerKwhLbp: settings.priceLBP || null,
    fixedFeePolicy: null,
    totalConsumptionKwh: totalKwh,
    totalUsd: totalUSD,
    totalLbp: totalLBP,
    totalExtrasUsd: totalExtrasUsd,
    totalDiscountUsd: totalDiscountUsd,
    totalExpensesUsd: totalExpensesUsd,
    netProfitUsd: netProfitUsd,
    customersSummary: Array.from(customerMap.values()),
    invoiceIds
  };

  // Save to LocalDB under 'archivedReports' map
  const archived = LocalDB.load('archivedReports', {});
  archived[period] = snapshot;
  LocalDB.save('archivedReports', archived);
}

async function loadArchivedReportsList(){
  const archived = LocalDB.load('archivedReports', {});
  const list = Object.keys(archived).map(k => ({ id: k, ...archived[k] }));

  // sort newest first
  list.sort((a,b)=> b.id.localeCompare(a.id));

  const container = qs('#archivedReports');
  container.innerHTML = '';
  if(list.length === 0){ container.innerHTML = '<div class="muted">لا توجد تقارير مؤرشفة</div>'; return; }

  list.forEach(item=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px 0';
    div.innerHTML = `<div><strong>${item.id}</strong> — ${item.dateRange?.start || ''} → ${item.dateRange?.end || ''}</div>
      <div>
        <button class="btn ghost" onclick='viewArchivedReport("${item.id}")'>عرض</button>
        <button class="btn ghost" onclick='printArchivedReport("${item.id}")'>طباعة</button>
        <button class="btn ghost" onclick='downloadArchivedReportExcel("${item.id}")'>تصدير إكسل</button>
      </div>`;
    container.appendChild(div);
  });
}

// expose helpers to global scope for inline onclick handlers
window.viewArchivedReport = async function(id){
  const archived = LocalDB.load('archivedReports', {});
  const snap = archived[id];
  if(!snap){ alert('التقرير غير موجود'); return; }
  // render a simple view inside reportArea
  const html = `<h3>تقرير ${id}</h3>
    <div>نطاق التاريخ: ${snap.dateRange.start} — ${snap.dateRange.end} (${snap.dateRange.timezone})</div>
    <div style="margin-top:8px"><strong>الإجماليات:</strong>
      <div>Total Kwh: ${Number(snap.totalConsumptionKwh).toLocaleString('en-US')}</div>
      <div>Total USD: ${Number(snap.totalUsd).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      <div>Total LBP: ${Number(snap.totalLbp).toLocaleString('en-US')}</div>
    </div>
    <div style="margin-top:8px"><button class='btn' onclick='printArchivedReport("${id}")'>طباعة التقرير</button></div>`;
  qs('#reportArea').innerHTML = html;
};

// generate a printable A4 HTML for a snapshot
function generateArchivedReportHtml(snap){
  const subscriptionTitle = settings.subscriptionName || 'تقرير';
  const printedAt = new Date().toISOString().slice(0,10);
  const operator = (window.currentUser && window.currentUser.displayName) || (window.currentUser && window.currentUser.uid) || '';

  const totalsHtml = `
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px">
      <div style="flex:1;min-width:160px;border:1px solid #444;padding:8px;border-radius:4px">
        <div style="font-size:11px;color:#333">Total Kwh</div>
        <div style="font-weight:800;font-size:16px">${Number(snap.totalConsumptionKwh||0).toLocaleString('en-US')}</div>
      </div>
      <div style="flex:1;min-width:160px;border:1px solid #444;padding:8px;border-radius:4px">
        <div style="font-size:11px;color:#333">Total USD</div>
        <div style="font-weight:800;font-size:16px">${Number(snap.totalUsd||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      </div>
      <div style="flex:1;min-width:160px;border:1px solid #444;padding:8px;border-radius:4px">
        <div style="font-size:11px;color:#333">Total LBP</div>
        <div style="font-weight:800;font-size:16px">${Number(snap.totalLbp||0).toLocaleString('en-US')}</div>
      </div>
      <div style="flex:1;min-width:160px;border:1px solid #444;padding:8px;border-radius:4px">
        <div style="font-size:11px;color:#333">Expenses (USD)</div>
        <div style="font-weight:800;font-size:16px">${Number(snap.totalExpensesUsd||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      </div>
      <div style="flex:1;min-width:160px;border:1px solid #444;padding:8px;border-radius:4px">
        <div style="font-size:11px;color:#333">Net Profit (USD)</div>
        <div style="font-weight:800;font-size:16px">${Number(snap.netProfitUsd||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      </div>
    </div>`;

  const customersRows = (snap.customersSummary||[]).map(c=>{
    return `<tr>
      <td style="padding:6px;border:1px solid #ddd;text-align:left">${c.customerName||''}</td>
      <td style="padding:6px;border:1px solid #ddd;text-align:left">${Number(c.invoicesCount||0).toLocaleString('en-US')}</td>
      <td style="padding:6px;border:1px solid #ddd;text-align:left">${Number(c.sumConsumptionKwh||0).toLocaleString('en-US')}</td>
      <td style="padding:6px;border:1px solid #ddd;text-align:left">${Number(c.sumUsd||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td style="padding:6px;border:1px solid #ddd;text-align:left">${Number(c.sumLbp||0).toLocaleString('en-US')}</td>
    </tr>`;
  }).join('');

  const html = `<!doctype html>
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=1122">
      <title>تقرير ${snap.period}</title>
      <style>
        @page { size: A4; margin: 20mm; }
        html,body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;color:#000}
        .report-wrapper{width:100%;font-size:12px}
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        header .left{text-align:right}
        header .right{text-align:left}
        h1{margin:0;font-size:18px}
        .meta{font-size:11px;color:#333;margin-bottom:8px}
        .content{margin-bottom:32px}
        table{width:100%;border-collapse:collapse;margin-bottom:12px}
        thead th{background:#f5f5f5;border:1px solid #ddd;padding:8px}
        tbody td{padding:6px;border:1px solid #ddd}
        /* ensure table header repeats on each printed page */
        thead{display:table-header-group}
        tfoot{display:table-footer-group}
        .page-footer{position:fixed;bottom:10mm;left:0;right:0;text-align:center;font-size:11px;color:#666}
        .small{font-size:11px;color:#444}
        @media print{
          .page-footer:after{content: "Page " counter(page) " of " counter(pages);}
        }
      </style>
    </head>
    <body>
      <div class="report-wrapper">
        <header>
          <div class="left">
            <h1>${subscriptionTitle}</h1>
            <div class="small">تقرير شهري: ${snap.period}</div>
            <div class="small">نطاق التاريخ: ${snap.dateRange?.start || ''} — ${snap.dateRange?.end || ''} (${snap.dateRange?.timezone||''})</div>
          </div>
          <div class="right" style="text-align:left">
            <div class="small">تاريخ الإنشاء: ${snap.createdAt && snap.createdAt.seconds ? new Date(snap.createdAt.seconds*1000).toISOString().slice(0,10) : (snap.createdAt||'')}</div>
            <div class="small">معدلات مستخدمة: Rate ${Number(snap.exchangeRateUsed||0).toLocaleString('en-US')}</div>
          </div>
        </header>

        <div class="meta">${totalsHtml}</div>

        <section class="content">
          <h3 style="margin-bottom:6px">ملخص العملاء</h3>
          <table>
            <thead>
              <tr>
                <th>اسم الزبون</th>
                <th>عدد الوصلات</th>
                <th>مجموع الكيلو واط</th>
                <th>مجموع USD</th>
                <th>مجموع LBP</th>
              </tr>
            </thead>
            <tbody>
              ${customersRows}
            </tbody>
          </table>
        </section>

        <div class="small">ملاحظات: ${snap.notes || ''}</div>
      </div>
      <div class="page-footer">طباعة: ${printedAt} — بواسطة: ${operator}</div>
    </body>
    </html>`;

  return html;
}

window.printArchivedReport = async function(id){
  const archived = LocalDB.load('archivedReports', {});
  const snap = archived[id];
  if(!snap){ alert('التقرير غير موجود'); return; }
  const html = generateArchivedReportHtml(snap);
  openPrintWindow(html);
};

window.downloadArchivedReport = function(id){
  const archived = LocalDB.load('archivedReports', {});
  const snap = archived[id];
  if(!snap){ alert('لا يوجد تقرير للتحميل'); return; }
  const blob = new Blob([JSON.stringify(snap, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `report-${id}.json`; document.body.appendChild(a); a.click(); a.remove();
};

window.downloadArchivedReportExcel = function(id){
  // Build CSV for customers summary and overall totals; user requested Excel per month
  const archived = LocalDB.load('archivedReports', {});
  const snap = archived[id];
  if(!snap){ alert('لا يوجد تقرير للتصدير'); return; }

  // CSV for summary
  const rows = [];
  rows.push(['Report', id]);
  rows.push(['Period', `${snap.dateRange.start} - ${snap.dateRange.end}`]);
  rows.push([]);
  rows.push(['Totals']);
  // Use raw numeric values in CSV (no thousands separators) so Excel displays correctly
  rows.push(['Total Kwh', Number(snap.totalConsumptionKwh||0).toString()]);
  rows.push(['Total USD', Number(snap.totalUsd||0).toFixed(2)]);
  rows.push(['Total LBP', Number(snap.totalLbp||0).toString()]);
  rows.push(['Expenses USD', Number(snap.totalExpensesUsd||0).toFixed(2)]);
  rows.push(['Net Profit USD', Number(snap.netProfitUsd||0).toFixed(2)]);
  rows.push([]);
  rows.push(['Customers Summary']);
  rows.push(['Customer Name','Invoices Count','Sum Kwh','Sum USD','Sum LBP']);
  (snap.customersSummary||[]).forEach(c=> rows.push([
    c.customerName||'',
    Number(c.invoicesCount||0).toString(),
    Number(c.sumConsumptionKwh||0).toString(),
    Number(c.sumUsd||0).toFixed(2),
    Number(c.sumLbp||0).toString()
  ]));

  // convert rows to CSV string
  const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  // Prefix BOM so Excel recognizes UTF-8 and numeric columns parse correctly
  const csvContent = '\uFEFF' + csv;
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `report-${id}.csv`; document.body.appendChild(a); a.click(); a.remove();
};
qs('#btnRunReport').onclick = runReport;
qs('#btnPrintAll').onclick = printAllInvoices;
qs('#btnCloseMonth').onclick = async ()=>{
  const key = qs('#r_month').value || new Date().toISOString().slice(0,7);
  if(!confirm(`سيتم إنشاء تقرير مؤرشف للشهر ${key}. متابعة؟`)) return;
  try{
    await createMonthlySnapshot(key);
    alert('تم أرشفة التقرير');
    runReport();
  }catch(e){ console.error(e); alert('فشل في إقفال الشهر: '+e.message); }
};
qs('#btnAddExpense').onclick = async ()=>{
  const key = qs('#r_month').value || monthKey(new Date());
  const amount = Number(qs('#exp_amount').value||0);
  if(!amount){ alert('أدخل قيمة المصروف'); return; }
  
  // Check if month is closed
  if (isMonthClosed(key)) {
    alert(`لا يمكن إضافة مصروف لشهر ${key} لأنه مقفول`);
    return;
  }
  
  const currency = qs('#exp_currency').value;
  const note = qs('#exp_note').value||'';
  
  try {
    const expense = { amount, currency, note, month: key, ts: Date.now() };
    await RTDB.push(`expenses/${key}`, expense);
    
    // Clear form
    qs('#exp_amount').value=''; 
    qs('#exp_note').value='';
    
    alert('تم إضافة المصروف بنجاح');
  } catch (error) {
    console.error('Error adding expense:', error);
    alert('فشل في إضافة المصروف: ' + error.message);
  }
};

// ------- Defaults -------
function initDefaults(){
  // set default dates/months
  const today = new Date().toISOString().slice(0,10);
  const ym = monthKey(new Date());
  qs('#inv_date').value = today;
  qs('#h_month').value = ym;
  qs('#r_month').value = ym;
  if (isInitialized) {
    computeInvoiceTotals();
    updateReports();
  }
}
// Bind close month button
document.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('btnCloseMonth');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeMonth);
  }
});

</script>
</body>
</html>

